<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuestGlow Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>GuestGlow Authentication Test</h1>
    
    <div id="config-test" class="test-result info">
        <h3>Configuration Test</h3>
        <div id="config-results">Testing...</div>
    </div>
    
    <div id="connection-test" class="test-result info">
        <h3>Supabase Connection Test</h3>
        <div id="connection-results">Testing...</div>
    </div>
    
    <div id="auth-test" class="test-result info">
        <h3>Authentication Test</h3>
        <input type="email" id="email" placeholder="Email" value="g.basera@yahoo.com">
        <input type="password" id="password" placeholder="Password" value="test123">
        <button onclick="testAuth()">Test Sign In</button>
        <div id="auth-results">Ready to test...</div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Configuration from .env file
        const SUPABASE_URL = "https://wzfpltamwhkncxjvulik.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6ZnBsdGFtd2hrbmN4anZ1bGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NDI5NTksImV4cCI6MjA3MDAxODk1OX0.4m707IwEkfrE-HIJFoP8hUz6VckZTTc_3CgH44f68Hk";

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Test configuration
        function testConfig() {
            const configDiv = document.getElementById('config-results');
            let results = [];
            
            results.push(`Supabase URL: ${SUPABASE_URL}`);
            results.push(`Supabase Key (first 20 chars): ${SUPABASE_KEY.substring(0, 20)}...`);
            results.push(`Client initialized: ${supabase ? 'Yes' : 'No'}`);
            
            configDiv.innerHTML = results.join('<br>');
            document.getElementById('config-test').className = 'test-result success';
        }

        // Test Supabase connection
        async function testConnection() {
            const connectionDiv = document.getElementById('connection-results');
            
            try {
                // Test basic connection by trying to get session
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                connectionDiv.innerHTML = `Connection successful! Current session: ${session ? 'Authenticated' : 'Not authenticated'}`;
                document.getElementById('connection-test').className = 'test-result success';
                
                // Test database connection
                const { data, error: dbError } = await supabase.from('tenants').select('name, slug').limit(1);
                
                if (dbError) {
                    connectionDiv.innerHTML += `<br>Database connection failed: ${dbError.message}`;
                    document.getElementById('connection-test').className = 'test-result error';
                } else {
                    connectionDiv.innerHTML += `<br>Database connection successful! Found tenant: ${data[0]?.name}`;
                }
                
            } catch (error) {
                connectionDiv.innerHTML = `Connection failed: ${error.message}`;
                document.getElementById('connection-test').className = 'test-result error';
            }
        }

        // Test authentication
        async function testAuth() {
            const authDiv = document.getElementById('auth-results');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                authDiv.innerHTML = 'Please enter email and password';
                return;
            }
            
            authDiv.innerHTML = 'Testing authentication...';
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                
                if (error) {
                    throw error;
                }
                
                authDiv.innerHTML = `Authentication successful!<br>User: ${data.user.email}<br>Session: ${data.session ? 'Active' : 'None'}`;
                document.getElementById('auth-test').className = 'test-result success';
                
                // Test tenant access
                const { data: tenantData, error: tenantError } = await supabase
                    .from('user_roles')
                    .select('tenant_id, role, tenants(name, slug)')
                    .eq('user_id', data.user.id);
                
                if (tenantError) {
                    authDiv.innerHTML += `<br>Tenant access check failed: ${tenantError.message}`;
                } else {
                    authDiv.innerHTML += `<br>Tenant access: ${tenantData.length} tenant(s) found`;
                    tenantData.forEach(role => {
                        authDiv.innerHTML += `<br>- ${role.tenants.name} (${role.role})`;
                    });
                }
                
            } catch (error) {
                authDiv.innerHTML = `Authentication failed: ${error.message}`;
                document.getElementById('auth-test').className = 'test-result error';
                console.error('Auth error:', error);
            }
        }

        // Run tests on page load
        window.onload = function() {
            testConfig();
            testConnection();
        };
    </script>
</body>
</html>
