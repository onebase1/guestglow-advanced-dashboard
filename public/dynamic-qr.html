<!-- Moved from Dynamic QR Generator.html. Tenant slug auto-detected from URL path for building links. -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic QR Generator</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f6f8fb; }
    .container { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
    .header { text-align: center; margin-bottom: 24px; }
    .header h1 { color: #003D7A; margin: 0 0 8px; }
    .control-panel { background: #f8f9fa; padding: 16px; border-radius: 10px; margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .form-group { margin-bottom: 12px; }
    label { display: block; font-weight: 600; font-size: 14px; color: #003D7A; margin-bottom: 6px; }
    input, select { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; }
    .btn { background: #003D7A; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 4px; }
    .btn:hover { background: #0066CC; }
    .btn-success { background: #28a745; }
    .btn-success:hover { background: #218838; }
    .qr-output { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px; }
    .qr-wrapper { border: 2px solid #003D7A; border-radius: 10px; padding: 12px; text-align: center; background: white; }
    .url-display { background: #f1f3f4; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 11px; word-break: break-all; margin: 8px 0; }
    .download-btn { background: #e74c3c; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; }
  </style>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Dynamic QR Generator</h1>
      <p>Generate QR codes on-demand for any room or location</p>
    </div>
    <div class="control-panel">
      <h3>Branding</h3>
      <div class="form-row">
        <div class="form-group">
          <label>QR Color</label>
          <input type="color" id="qr-color" value="#003D7A" />
        </div>
        <div class="form-group">
          <label>Background</label>
          <input type="color" id="bg-color" value="#ffffff" />
        </div>
        <div class="form-group">
          <label>Error Correction</label>
          <select id="ecc">
            <option value="H" selected>H (Best)</option>
            <option value="Q">Q</option>
            <option value="M">M</option>
            <option value="L">L</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Logo</label>
          <input type="file" id="logo-upload" accept="image/*" />
          <button class="btn" id="use-default-logo" style="margin-top:6px">Use Hotel Logo</button>
          <button class="btn" id="remove-logo" style="margin-top:6px">Remove Logo</button>
        </div>
        <div class="form-group">
          <label>Margin</label>
          <input type="number" id="margin" value="10" min="0" max="50" />
        </div>
      </div>
    </div>

    <div class="control-panel">
      <h3>Single QR Generator</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="room-number">Room Number</label>
          <input type="text" id="room-number" placeholder="e.g., 101, 205A, Suite-1" />
        </div>
        <div class="form-group">
          <label>Size</label>
          <select id="qr-size">
            <option value="300" selected>300 px</option>
            <option value="600">600 px</option>
            <option value="1000">1000 px</option>
          </select>
        </div>
        <div class="form-group">
          <label for="location-name">Or Location Name</label>
          <input type="text" id="location-name" placeholder="e.g., Spa, Pool, Conference Room A" />
        </div>
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category">
            <option value="rooms">Rooms</option>
            <option value="service">Service</option>
            <option value="restaurant">Restaurant</option>
            <option value="amenities">Amenities</option>
          </select>
        </div>
      </div>
      <button class="btn" onclick="generateSingleQR()">Generate Single QR</button>
      <button class="btn btn-success" onclick="clearOutput()">Clear All</button>
    </div>
    </div>

    <div class="control-panel" id="live-preview" style="display:none; background:#eef7ff">
      <h3>Live Preview</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Preview</label>
          <div class="qr-container"><canvas id="preview-canvas" width="300" height="300"></canvas></div>
        </div>
        <div class="form-group">
          <label>URL</label>
          <div class="url-display" id="preview-url"></div>
          <button class="btn" id="copy-preview-link" type="button">Copy Link</button>
          <button class="download-btn" id="download-preview" type="button">Download PNG</button>
        </div>
      </div>
    </div>

    <div class="control-panel" style="background:#fff7e6">
      <h3>Batch Room Generator</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="from-room">From Room:</label>
          <input type="text" id="from-room" placeholder="e.g., 101" />
        </div>
        <div class="form-group">
          <label for="to-room">To Room:</label>
          <input type="text" id="to-room" placeholder="e.g., 150" />
        </div>
        <div class="form-group">
          <label for="room-prefix">Room Prefix (optional):</label>
          <input type="text" id="room-prefix" placeholder="e.g., A, B, Suite" />
        </div>
      </div>
      <button class="btn" onclick="generateRoomBatch()">Generate Room Batch</button>
      <button class="btn btn-success" onclick="generateCommonAreas()">Generate Common Areas</button>
      <button class="btn" id="download-all">Download All as ZIP</button>
    </div>

    <div id="status" style="display:none; background:#d4edda; border:1px solid #c3e6cb; color:#155724; padding:8px; border-radius:6px; margin:10px 0;"></div>

    <div id="qr-output" class="qr-output"></div>
  </div>

  <script>
    let logoDataUrl = '/eusbett-logo.jpeg'; // default to the correct hotel image you added
    const logoImage = new Image();
    function setLogo(src){ logoDataUrl = src; logoImage.src = src; }
    setLogo(logoDataUrl);
    const logoReady = logoImage.decode ? logoImage.decode() : new Promise(resolve => { if (logoImage.complete) resolve(); else logoImage.onload = () => resolve(); });
    document.getElementById('logo-upload').addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => setLogo(reader.result);
      reader.readAsDataURL(file);
    });
    document.getElementById('use-default-logo').addEventListener('click', () => setLogo('/eusbett-logo.jpeg'));
    document.getElementById('remove-logo').addEventListener('click', () => setLogo(''));


    function currentTenantSlug() {
      // Prefer explicit tenant in query (?tenant=slug), otherwise use first path segment
      const q = new URLSearchParams(location.search).get('tenant');
      if (q) return q;
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length ? parts[0] : 'eusbett';
    }

    function buildFeedbackLink(name, category) {
      // Directly open the in-app Quick Feedback route (no auth required)
      const origin = window.location.origin;
      const tenant = currentTenantSlug();
      const params = new URLSearchParams();
      if (category) params.set('category', category);
      // If name looks numeric or alphanumeric without spaces, treat as room; else as area
      if (name && /^[-\w]+$/.test(name)) {
        params.set('room', name);
      } else if (name) {
        params.set('area', name);
      }
      const qs = params.toString();
      return `${origin}/${tenant}/quick-feedback${qs ? `?${qs}` : ''}`;
    }

    async function drawQRWithLogo(url, canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const size = canvas.width;
      const colorEl = document.getElementById('qr-color');
      const bgEl = document.getElementById('bg-color');
      const eccEl = document.getElementById('ecc');
      const marginEl = document.getElementById('margin');
      const color = (colorEl && colorEl.value ? colorEl.value : '#003D7A').replace('#','');
      const bg = (bgEl && bgEl.value ? bgEl.value : '#ffffff').replace('#','');
      const ecc = (eccEl && eccEl.value) ? eccEl.value : 'H';
      const margin = parseInt((marginEl && marginEl.value) ? marginEl.value : '10', 10);
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(url)}&color=${color}&bgcolor=${bg}&margin=${margin}&ecc=${ecc}`;
      try {
        const response = await fetch(qrUrl);
        const blob = await response.blob();
        const bitmap = await createImageBitmap(blob);
        ctx.clearRect(0, 0, size, size);
        ctx.drawImage(bitmap, 0, 0, size, size);
        if (logoDataUrl) {
          const logoRatio = 0.267; const logoSize = size * logoRatio;
          const x = (size - logoSize) / 2; const y = (size - logoSize) / 2;
          const pad = logoSize * 0.2; const bgSize = logoSize + pad;
          const bgX = (size - bgSize) / 2; const bgY = (size - bgSize) / 2; const radius = bgSize * 0.12;
          ctx.fillStyle = '#FFFFFF'; ctx.beginPath();
          ctx.moveTo(bgX + radius, bgY); ctx.lineTo(bgX + bgSize - radius, bgY); ctx.quadraticCurveTo(bgX + bgSize, bgY, bgX + bgSize, bgY + radius);
          ctx.lineTo(bgX + bgSize, bgY + bgSize - radius); ctx.quadraticCurveTo(bgX + bgSize, bgY + bgSize, bgX + bgSize - radius, bgY + bgSize);
          ctx.lineTo(bgX + radius, bgY + bgSize); ctx.quadraticCurveTo(bgX, bgY + bgSize, bgX, bgY + bgSize - radius);
          ctx.lineTo(bgX, bgY + radius); ctx.quadraticCurveTo(bgX, bgY, bgX + radius, bgY); ctx.closePath(); ctx.fill();
          await logoReady; ctx.drawImage(logoImage, x, y, logoSize, logoSize);
        }
      } catch (e) { console.error('QR draw error', e); }
    }

    // Live preview helpers (standalone)
    function getSingleInputName(){
      const roomNumberEl = document.getElementById('room-number');
      const locationNameEl = document.getElementById('location-name');
      const roomNumber = roomNumberEl && 'value' in roomNumberEl ? roomNumberEl.value.trim() : '';
      const locationName = locationNameEl && 'value' in locationNameEl ? locationNameEl.value.trim() : '';
      return roomNumber || locationName;
    }

    function getSingleUrl(){
      const categoryEl = document.getElementById('category');
      const category = categoryEl && 'value' in categoryEl ? categoryEl.value : 'rooms';
      const name = getSingleInputName();
      if (!name) return '';
      return buildFeedbackLink(name, category);
    }

    async function updatePreview(){
      try {
        const url = getSingleUrl();
        const preview = document.getElementById('live-preview');
        const sizeSel = document.getElementById('qr-size');
        const size = parseInt((sizeSel && 'value' in sizeSel ? sizeSel.value : '300'), 10);
        const canvas = document.getElementById('preview-canvas');
        if (!canvas) return;
        canvas.width = size; canvas.height = size;
        if (!url){ if (preview) preview.style.display = 'none'; return; }
        if (preview) preview.style.display = 'block';
        const urlDiv = document.getElementById('preview-url'); if (urlDiv) urlDiv.textContent = url;
        await drawQRWithLogo(url, 'preview-canvas');
      } catch {}
    }

    // Wire up events safely
    ['room-number','location-name','category','qr-color','bg-color','ecc','margin','qr-size']
      .forEach(id => { const el = document.getElementById(id); if (el && el.addEventListener) el.addEventListener('input', updatePreview); });

    const copySingleBtn = document.getElementById('copy-single-link');
    if (copySingleBtn && copySingleBtn.addEventListener) copySingleBtn.addEventListener('click', async ()=>{
      const url = getSingleUrl();
      if (!url) { alert('Please enter a room number or location first'); return; }
      await navigator.clipboard.writeText(url);
      showStatus('Link copied to clipboard');
    });
    const copyPrevBtn = document.getElementById('copy-preview-link');
    if (copyPrevBtn && copyPrevBtn.addEventListener) copyPrevBtn.addEventListener('click', async ()=>{
      const url = getSingleUrl();
      if (!url) return; await navigator.clipboard.writeText(url);
      showStatus('Preview link copied');
    });

    const downloadPrevBtn = document.getElementById('download-preview');
    if (downloadPrevBtn && downloadPrevBtn.addEventListener) downloadPrevBtn.addEventListener('click', ()=>{
      const sizeSel = document.getElementById('qr-size');
      const size = parseInt((sizeSel && 'value' in sizeSel ? sizeSel.value : '300'), 10);
      const name = getSingleInputName() || 'QR';
      downloadCanvas('preview-canvas', `Eusbett-${name.replace(/\s+/g,'-')}-${size}.png`);
    });

    window.addEventListener('load', () => { updatePreview(); });

	    function generateRoomBatch() {
	      const from = document.getElementById('from-room').value.trim();
	      const to = document.getElementById('to-room').value.trim();
	      const prefix = document.getElementById('room-prefix').value.trim();
	      if (!from || !to) { alert('Please enter from and to room numbers'); return; }
	      const start = parseInt(from, 10), end = parseInt(to, 10);
	      if (isNaN(start) || isNaN(end) || end < start) { alert('Invalid room range'); return; }
	      for (let n = start; n <= end; n++) {
	        const label = prefix ? `${prefix}-${n}` : `${n}`;
	        const url = buildFeedbackLink(label, 'rooms');
	        const canvasId = `qr-${Date.now()}-${n}`;
	        const wrapper = document.createElement('div'); wrapper.className = 'qr-wrapper';
	        wrapper.innerHTML = `<h4>Room ${label}</h4><div class="qr-container"><canvas id="${canvasId}" width="300" height="300"></canvas></div><div class="url-display">${url}</div><button class="download-btn" onclick="downloadCanvas('${canvasId}', 'Eusbett-Room-${label}-QR.png')">Download QR</button>`;
	        document.getElementById('qr-output').appendChild(wrapper);
	        drawQRWithLogo(url, canvasId);
	      }
	      showStatus('Generated batch rooms');
	    }

	    function generateCommonAreas() {
	      const common = ['Reception','Lobby','Restaurant','Breakfast','Pool','Spa','Gym','Conference','Bar'];
	      const category = document.getElementById('category').value;
	      for (const name of common) {
	        const url = buildFeedbackLink(name, category === 'rooms' ? 'amenities' : category);
	        const canvasId = `qr-${Date.now()}-${name.replace(/\s+/g,'-')}`;
	        const wrapper = document.createElement('div'); wrapper.className = 'qr-wrapper';
	        wrapper.innerHTML = `<h4>${name}</h4><div class="qr-container"><canvas id="${canvasId}" width="300" height="300"></canvas></div><div class="url-display">${url}</div><button class="download-btn" onclick="downloadCanvas('${canvasId}', 'Eusbett-${name.replace(/\s+/g,'-')}-QR.png')">Download QR</button>`;
	        document.getElementById('qr-output').appendChild(wrapper);
	        drawQRWithLogo(url, canvasId);
	      }
	      showStatus('Generated common areas');
	    }



    function generateSingleQR() {
      const roomNumber = document.getElementById('room-number').value.trim();
      const locationName = document.getElementById('location-name').value.trim();
      const category = document.getElementById('category').value;
      if (!roomNumber && !locationName) { alert('Please enter either a room number or location name'); return; }
      const output = document.getElementById('qr-output'); const canvasId = `qr-${Date.now()}`;
      const wrapper = document.createElement('div'); wrapper.className = 'qr-wrapper';

      let displayName, url; if (roomNumber) { displayName = `Room ${roomNumber}`; url = buildFeedbackLink(roomNumber, category); } else { displayName = locationName; url = buildFeedbackLink(locationName, category); }
      wrapper.innerHTML = `<h4>${displayName}</h4><div class="qr-container"><canvas id="${canvasId}" width="300" height="300"></canvas></div><div class="url-display">${url}</div><button class="download-btn" onclick="downloadCanvas('${canvasId}', 'Eusbett-${displayName.replace(/\s+/g, '-')}-QR.png')">Download QR</button>`;
      output.appendChild(wrapper); drawQRWithLogo(url, canvasId); showStatus(`Generated QR for ${displayName}`);
    }

    // Download all current canvases as a ZIP (outside of generateSingleQR)
    const downloadAllBtn = document.getElementById('download-all');
    if (downloadAllBtn) downloadAllBtn.addEventListener('click', async () => {
      try {
        const zip = new JSZip();
        const canvases = document.querySelectorAll('#qr-output canvas');
        if (!canvases.length) { alert('No QR codes to download'); return; }
        let idx = 1;
        for (const c of canvases) {
          const dataUrl = c.toDataURL('image/png');
          const base64 = dataUrl.substring(dataUrl.indexOf(',') + 1);
          zip.file(`qr-${idx++}.png`, base64, { base64: true });
        }
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'qr-batch.zip';
        a.click();
        URL.revokeObjectURL(a.href);
        showStatus('ZIP downloaded');
      } catch (e) {
        console.error('ZIP error', e);
        alert('Could not create ZIP');
      }
    });

    function downloadCanvas(canvasId, filename) { const canvas = document.getElementById(canvasId); const link = document.createElement('a'); link.href = canvas.toDataURL('image/png'); link.download = filename; link.click(); }
    function clearOutput() { document.getElementById('qr-output').innerHTML = ''; showStatus('Cleared all QR codes'); }
    function showStatus(message) { const s = document.getElementById('status'); s.textContent = message; s.style.display = 'block'; setTimeout(()=>{ s.style.display='none'; }, 2000); }
    window.addEventListener('load', ()=> showStatus('QR Generator ready!'))
  </script>
</body>
</html>

