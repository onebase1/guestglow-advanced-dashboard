<!DOCTYPE html>
<html>
<head>
    <title>üß™ Test GuestGlow Email System</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #2563eb; }
        .test-button { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 10px 5px; font-size: 14px; }
        .test-button:hover { background: #1d4ed8; }
        .test-button.success { background: #059669; }
        .test-button.error { background: #dc2626; }
        .results { background: white; padding: 15px; border-radius: 6px; margin: 10px 0; border: 1px solid #e5e7eb; }
        .log { font-family: monospace; font-size: 12px; background: #1f2937; color: #f3f4f6; padding: 10px; border-radius: 4px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
        .status { padding: 8px 12px; border-radius: 4px; margin: 5px 0; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <h1>üß™ GuestGlow Email System Test</h1>
    <p>This tool tests the new Resend-based email system to ensure all functions work correctly.</p>

    <div class="test-section">
        <h2>üìß Core Email Service Test</h2>
        <p>Test the main send-tenant-emails function with different email types.</p>
        <button class="test-button" onclick="testCoreEmailService()">Test Core Email Service</button>
        <div id="coreEmailResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üîî Feedback Email Test</h2>
        <p>Test the complete feedback email flow (manager + guest notifications).</p>
        <button class="test-button" onclick="testFeedbackEmails()">Test Feedback Emails</button>
        <div id="feedbackEmailResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üì± QR Code Email Test</h2>
        <p>Test sending feedback links via email.</p>
        <button class="test-button" onclick="testFeedbackLink()">Test Feedback Link Email</button>
        <div id="feedbackLinkResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üôè Thank You Generator Test</h2>
        <p>Test the thank you response generator for different ratings.</p>
        <button class="test-button" onclick="testThankYouGenerator()">Test Thank You Generator</button>
        <div id="thankYouResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìä GM Introduction Email Test</h2>
        <p>Test the GM introduction email that will be sent to Robert and Edward.</p>
        <button class="test-button" onclick="testGMIntroEmail()">Send Preview to g.basera5@gmail.com</button>
        <div id="gmIntroResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìà Email Analytics Test</h2>
        <p>Test the email analytics and reporting system.</p>
        <button class="test-button" onclick="testEmailAnalytics()">Test Analytics Dashboard</button>
        <div id="analyticsResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üì¨ Email Queue Test</h2>
        <p>Test the email queue and retry system.</p>
        <button class="test-button" onclick="testEmailQueue()">Test Email Queue</button>
        <div id="queueResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìÖ Scheduled Reports Test</h2>
        <p>Test the scheduled email reports system.</p>
        <button class="test-button" onclick="testScheduledReports()">Test Scheduled Reports</button>
        <div id="scheduledResults" class="results" style="display: none;"></div>
    </div>

    <div id="globalLog" class="log" style="display: none;"></div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://wzfpltamwhkncxjvulik.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6ZnBsdGFtd2hrbnN4anZ1bGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NDI5NTksImV4cCI6MjA3MDAxODk1OX0.4m707IwEkfrE-HIJFoP8hUz6VckZTTc_3CgH44f68Hk'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        function log(message) {
            const logDiv = document.getElementById('globalLog')
            logDiv.style.display = 'block'
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n'
            logDiv.scrollTop = logDiv.scrollHeight
            console.log(message)
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId)
            element.style.display = 'block'
            element.innerHTML = `<div class="status ${type}">${content}</div>`
        }

        async function testCoreEmailService() {
            log('üß™ Testing core email service...')
            showResult('coreEmailResults', '‚è≥ Testing core email service...', 'info')

            try {
                const { data, error } = await supabase.functions.invoke('send-tenant-emails', {
                    body: {
                        email_type: 'system_notification',
                        recipient_email: 'g.basera5@gmail.com',
                        subject: 'üß™ Test Email - Core Service Verification',
                        html_content: `
                            <div style="font-family: Arial, sans-serif; padding: 20px;">
                                <h2>‚úÖ Email System Test Successful!</h2>
                                <p>This is a test email from the new GuestGlow email system.</p>
                                <p><strong>Test Details:</strong></p>
                                <ul>
                                    <li>Function: send-tenant-emails</li>
                                    <li>Email Type: system_notification</li>
                                    <li>Sender: system@guest-glow.com</li>
                                    <li>Time: ${new Date().toLocaleString()}</li>
                                </ul>
                                <p>If you received this email, the core email service is working correctly!</p>
                            </div>
                        `,
                        tenant_id: '27843a9a-b53f-482a-87ba-1a3e52f55dc1',
                        tenant_slug: 'eusbett',
                        priority: 'normal'
                    }
                })

                if (error) throw error

                log('‚úÖ Core email service test successful')
                showResult('coreEmailResults', `‚úÖ Email sent successfully! Email ID: ${data.email_id}<br>Check g.basera5@gmail.com for the test email.`, 'success')
            } catch (error) {
                log('‚ùå Core email service test failed: ' + error.message)
                showResult('coreEmailResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        async function testFeedbackEmails() {
            log('üß™ Testing feedback email flow...')
            showResult('feedbackEmailResults', '‚è≥ Testing feedback email flow...', 'info')

            try {
                // First create a test feedback entry
                const { data: feedbackData, error: feedbackError } = await supabase.rpc('insert_feedback_with_tenant', {
                    p_tenant_slug: 'eusbett',
                    p_guest_name: 'Test Guest',
                    p_guest_email: 'g.basera5@gmail.com',
                    p_room_number: '101',
                    p_check_in_date: null,
                    p_check_out_date: null,
                    p_rating: 3,
                    p_feedback_text: 'Test feedback for email system verification',
                    p_issue_category: 'Food & Beverage',
                    p_would_recommend: null,
                    p_source: 'email_test'
                })

                if (feedbackError) throw feedbackError

                // Now test the email generation
                const { data, error } = await supabase.functions.invoke('generate-feedback-emails', {
                    body: {
                        feedback_id: feedbackData,
                        guest_name: 'Test Guest',
                        guest_email: 'g.basera5@gmail.com',
                        room_number: '101',
                        rating: 3,
                        feedback_text: 'Test feedback for email system verification',
                        issue_category: 'Food & Beverage',
                        tenant_id: '27843a9a-b53f-482a-87ba-1a3e52f55dc1',
                        tenant_slug: 'eusbett'
                    }
                })

                if (error) throw error

                log('‚úÖ Feedback email flow test successful')
                showResult('feedbackEmailResults', `‚úÖ Feedback emails sent successfully!<br>Manager email: ${data.results.manager_email ? '‚úÖ Sent' : '‚ùå Failed'}<br>Guest email: ${data.results.guest_email ? '‚úÖ Sent' : '‚ùå Failed'}<br>Check g.basera5@gmail.com for both emails.`, 'success')
            } catch (error) {
                log('‚ùå Feedback email flow test failed: ' + error.message)
                showResult('feedbackEmailResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        async function testFeedbackLink() {
            log('üß™ Testing feedback link email...')
            showResult('feedbackLinkResults', '‚è≥ Testing feedback link email...', 'info')

            try {
                const { data, error } = await supabase.functions.invoke('send-feedback-link', {
                    body: {
                        guestEmail: 'g.basera5@gmail.com',
                        roomNumber: '101',
                        feedbackUrl: 'https://guestglow-fresh.vercel.app/eusbett/quick-feedback?room=101',
                        qrCodeUrl: 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://guestglow-fresh.vercel.app/eusbett/quick-feedback?room=101'
                    }
                })

                if (error) throw error

                log('‚úÖ Feedback link email test successful')
                showResult('feedbackLinkResults', `‚úÖ Feedback link email sent successfully!<br>Check g.basera5@gmail.com for the feedback link email.`, 'success')
            } catch (error) {
                log('‚ùå Feedback link email test failed: ' + error.message)
                showResult('feedbackLinkResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        async function testThankYouGenerator() {
            log('üß™ Testing thank you generator...')
            showResult('thankYouResults', '‚è≥ Testing thank you generator...', 'info')

            try {
                const { data, error } = await supabase.functions.invoke('thank-you-generator', {
                    body: {
                        reviewText: 'Great service and clean rooms!',
                        rating: 5,
                        isExternal: false,
                        guestName: 'Test Guest',
                        tenant_id: '27843a9a-b53f-482a-87ba-1a3e52f55dc1',
                        tenant_slug: 'eusbett'
                    }
                })

                if (error) throw error

                log('‚úÖ Thank you generator test successful')
                showResult('thankYouResults', `‚úÖ Thank you response generated successfully!<br><div style="background: #f1f5f9; padding: 10px; border-radius: 4px; margin: 10px 0; font-style: italic;">${data.response.substring(0, 200)}...</div>`, 'success')
            } catch (error) {
                log('‚ùå Thank you generator test failed: ' + error.message)
                showResult('thankYouResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        async function testGMIntroEmail() {
            log('üß™ Testing GM introduction email...')
            showResult('gmIntroResults', '‚è≥ Sending GM introduction preview email...', 'info')

            try {
                const gmIntroHTML = `
                    <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 600px;">
                        <div style="background: #2563eb; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 24px;">üéâ GuestGlow Advanced Analytics</h1>
                            <p style="margin: 10px 0 0 0; font-size: 16px;">Your New Guest Experience Intelligence System</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 8px 8px;">
                            <h2 style="color: #333; margin-top: 0;">Dear Robert & Edward,</h2>
                            
                            <p>üöÄ <strong>PREVIEW EMAIL - SYSTEM TEST</strong></p>
                            
                            <p>We're excited to introduce you to GuestGlow Advanced Analytics - your comprehensive guest experience management system that's now live and ready to help you achieve your 4.5-star rating goal!</p>
                            
                            <div style="background: white; padding: 15px; border-radius: 6px; margin: 15px 0;">
                                <h3 style="color: #333; margin-top: 0;">üéØ System Capabilities</h3>
                                <ul>
                                    <li>‚úÖ Automated feedback collection and routing</li>
                                    <li>‚úÖ Real-time manager notifications</li>
                                    <li>‚úÖ Guest satisfaction tracking</li>
                                    <li>‚úÖ Performance analytics and reporting</li>
                                    <li>‚úÖ SLA monitoring and escalation</li>
                                </ul>
                            </div>
                            
                            <div style="background: #e0f2fe; padding: 15px; border-radius: 6px; margin: 15px 0;">
                                <h3 style="color: #0277bd; margin-top: 0;">üìä What You'll Receive</h3>
                                <p>Starting immediately, you'll receive automated reports including:</p>
                                <ul>
                                    <li>Daily feedback summaries</li>
                                    <li>Weekly performance analytics</li>
                                    <li>Monthly trend analysis</li>
                                    <li>Real-time alerts for urgent issues</li>
                                </ul>
                            </div>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <p style="background: #fef3c7; padding: 15px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                    <strong>üß™ This is a test email to verify the system is working correctly.</strong><br>
                                    If you receive this, the email system is ready for production!
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                                <p style="color: #666; font-size: 14px;">
                                    Best regards,<br>
                                    <strong>The GuestGlow Team</strong>
                                </p>
                                <p style="color: #999; font-size: 12px;">System Test - ${new Date().toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `

                const { data, error } = await supabase.functions.invoke('send-tenant-emails', {
                    body: {
                        email_type: 'gm_introduction_preview',
                        recipient_email: 'g.basera5@gmail.com',
                        bcc_emails: ['gizzy@guest-glow.com'],
                        subject: 'üß™ [PREVIEW TEST] GuestGlow Advanced Analytics - System Introduction',
                        html_content: gmIntroHTML,
                        tenant_id: '27843a9a-b53f-482a-87ba-1a3e52f55dc1',
                        tenant_slug: 'eusbett',
                        priority: 'normal',
                        custom_note: 'Preview test email for system verification'
                    }
                })

                if (error) throw error

                log('‚úÖ GM introduction email test successful')
                showResult('gmIntroResults', `‚úÖ GM introduction preview email sent successfully!<br>Email ID: ${data.email_id}<br><strong>Check g.basera5@gmail.com for the preview email.</strong><br><br>If this looks good, we can proceed to send the production version to Robert and Edward.`, 'success')
            } catch (error) {
                log('‚ùå GM introduction email test failed: ' + error.message)
                showResult('gmIntroResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        async function testEmailAnalytics() {
            log('üß™ Testing email analytics...')
            showResult('analyticsResults', '‚è≥ Testing email analytics...', 'info')

            try {
                const { data, error } = await supabase.functions.invoke('email-analytics', {
                    body: {
                        action: 'dashboard',
                        tenant_id: '27843a9a-b53f-482a-87ba-1a3e52f55dc1'
                    }
                })

                if (error) throw error

                log('‚úÖ Email analytics test successful')
                showResult('analyticsResults', `‚úÖ Analytics dashboard data retrieved!<br>
                    <strong>This Month:</strong> ${data.result.this_month.total_sent} emails sent, ${data.result.this_month.open_rate}% open rate<br>
                    <strong>This Week:</strong> ${data.result.this_week.total_sent} emails sent<br>
                    <strong>Today:</strong> ${data.result.today.total_sent} emails sent`, 'success')
            } catch (error) {
                log('‚ùå Email analytics test failed: ' + error.message)
                showResult('analyticsResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        async function testEmailQueue() {
            log('üß™ Testing email queue...')
            showResult('queueResults', '‚è≥ Testing email queue...', 'info')

            try {
                // First get queue status
                const { data: statusData, error: statusError } = await supabase.functions.invoke('email-queue', {
                    body: { action: 'status' }
                })

                if (statusError) throw statusError

                // Then enqueue a test email
                const { data: enqueueData, error: enqueueError } = await supabase.functions.invoke('email-queue', {
                    body: {
                        action: 'enqueue',
                        email_data: {
                            email_type: 'system_notification',
                            recipient_email: 'g.basera5@gmail.com',
                            subject: 'üß™ Test Queue Email',
                            html_content: '<p>This is a test email from the queue system.</p>',
                            tenant_id: '27843a9a-b53f-482a-87ba-1a3e52f55dc1',
                            tenant_slug: 'eusbett',
                            priority: 'normal'
                        }
                    }
                })

                if (enqueueError) throw enqueueError

                // Process the queue
                const { data: processData, error: processError } = await supabase.functions.invoke('email-queue', {
                    body: { action: 'process' }
                })

                if (processError) throw processError

                log('‚úÖ Email queue test successful')
                showResult('queueResults', `‚úÖ Email queue system working!<br>
                    <strong>Queue Status:</strong> ${statusData.result.total_queued} total items<br>
                    <strong>Enqueued:</strong> ${enqueueData.result.id}<br>
                    <strong>Processed:</strong> ${processData.result.processed} emails`, 'success')
            } catch (error) {
                log('‚ùå Email queue test failed: ' + error.message)
                showResult('queueResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        async function testScheduledReports() {
            log('üß™ Testing scheduled reports...')
            showResult('scheduledResults', '‚è≥ Testing scheduled reports...', 'info')

            try {
                const { data, error } = await supabase.functions.invoke('scheduled-email-reports', {
                    body: {
                        report_type: 'daily',
                        tenant_id: '27843a9a-b53f-482a-87ba-1a3e52f55dc1',
                        tenant_slug: 'eusbett',
                        recipients: ['g.basera5@gmail.com']
                    }
                })

                if (error) throw error

                log('‚úÖ Scheduled reports test successful')
                showResult('scheduledResults', `‚úÖ Daily report generated and sent!<br>
                    <strong>Recipients:</strong> ${data.recipients_count}<br>
                    <strong>Report Data:</strong> ${data.report_data.total_feedback} feedback items, ${data.report_data.average_rating}‚≠ê average<br>
                    Check g.basera5@gmail.com for the report email.`, 'success')
            } catch (error) {
                log('‚ùå Scheduled reports test failed: ' + error.message)
                showResult('scheduledResults', `‚ùå Test failed: ${error.message}`, 'error')
            }
        }

        // Auto-run core email test on page load
        window.addEventListener('load', () => {
            log('üöÄ Email system test page loaded')
            log('üìß Ready to test GuestGlow email functionality')
            log('üîß Make sure to set RESEND_API_KEY in Supabase environment variables')
        })
    </script>
</body>
</html>
